name: Release Builds

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., v0.13.0)"
        required: true
        default: "v0.13.0"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-linux:
    name: Build for Linux (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --locked

      - name: Strip binary
        run: strip target/release/gul

      - name: Create archive
        run: |
          cd target/release
          tar czf gul-${{ github.event.inputs.version || github.ref_name }}-linux-x86_64.tar.gz gul gul-mcp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gul-linux-x86_64
          path: target/release/gul-*.tar.gz

  build-windows:
    name: Build for Windows (x86_64)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --locked

      - name: Create archive
        shell: pwsh
        run: |
          cd target/release
          Compress-Archive -Path gul.exe,gul-mcp.exe -DestinationPath gul-${{ github.event.inputs.version || github.ref_name }}-windows-x86_64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gul-windows-x86_64
          path: target/release/gul-*.zip

  build-macos:
    name: Build for macOS (Universal)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build x86_64
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build ARM64
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create universal binaries
        run: |
          mkdir -p universal
          lipo -create \
            target/x86_64-apple-darwin/release/gul \
            target/aarch64-apple-darwin/release/gul \
            -output universal/gul
          lipo -create \
            target/x86_64-apple-darwin/release/gul-mcp \
            target/aarch64-apple-darwin/release/gul-mcp \
            -output universal/gul-mcp

      - name: Create archive
        run: |
          cd universal
          tar czf ../gul-${{ github.event.inputs.version || github.ref_name }}-macos-universal.tar.gz gul gul-mcp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gul-macos-universal
          path: gul-*.tar.gz

  build-raspberry-pi:
    name: Build for Raspberry Pi
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-gnueabihf
            name: rpi-armv7
            gcc: arm-linux-gnueabihf
          - target: aarch64-unknown-linux-gnu
            name: rpi-arm64
            gcc: aarch64-linux-gnu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.gcc }}

      - name: Cache Cargo
        uses: actions/upload-artifact@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Configure cross-compilation
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << EOF
          [target.${{ matrix.target }}]
          linker = "${{ matrix.gcc }}-gcc"
          EOF

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../gul-${{ github.event.inputs.version || github.ref_name }}-${{ matrix.name }}.tar.gz gul gul-mcp

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gul-${{ matrix.name }}
          path: gul-*-${{ matrix.name }}.tar.gz

  build-esp32:
    name: Build for ESP32-S3 (Xtensa)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install esp-rs toolchain
        run: |
          # Install espup
          curl -L https://github.com/esp-rs/espup/releases/latest/download/espup-x86_64-unknown-linux-gnu -o espup
          chmod +x espup
          ./espup install --targets esp32s3

          # Source environment
          . $HOME/export-esp.sh
          echo "ESP toolchain installed"

      - name: Install cargo-espflash
        run: |
          . $HOME/export-esp.sh
          cargo install cargo-espflash

      - name: Build for ESP32-S3
        run: |
          . $HOME/export-esp.sh
          cd packages/embedded/gul-esp32 || cd gul-esp32 || echo "ESP32 package not found, skipping"
          if [ -f "Cargo.toml" ]; then
            cargo +esp build --release --target xtensa-esp32s3-none-elf
            
            # Create firmware package
            cd target/xtensa-esp32s3-none-elf/release
            if [ -f "gul-esp32" ]; then
              # Generate bin file
              esptool.py --chip esp32s3 elf2image --output gul-esp32s3.bin gul-esp32
              zip ../../../gul-${{ github.event.inputs.version || github.ref_name }}-esp32s3.zip gul-esp32s3.bin
            fi
          else
            echo "ESP32 project not configured, creating placeholder"
            mkdir -p placeholder
            echo "ESP32-S3 build requires esp-rs toolchain setup" > placeholder/README.txt
            cd placeholder
            zip ../../gul-${{ github.event.inputs.version || github.ref_name }}-esp32s3.zip README.txt
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gul-esp32s3
          path: "**/*-esp32s3.zip"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      [build-linux, build-windows, build-macos, build-raspberry-pi, build-esp32]
    if: github.event_name == 'release'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.{tar.gz,zip}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
