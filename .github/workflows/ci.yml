name: GUL CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test both compilers
  compilers:
    name: Build & Test Compilers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gul_stable, gul_nightly]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.compiler }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build ${{ matrix.compiler }}
        run: cargo build -p ${{ matrix.compiler }} --release

      - name: Test ${{ matrix.compiler }}
        run: cargo test -p ${{ matrix.compiler }}

  # Run shared sanity tests on both compilers
  sanity-tests:
    name: Shared Sanity Tests
    runs-on: ubuntu-latest
    needs: compilers
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build compilers
        run: |
          cargo build -p gul_stable --release
          cargo build -p gul_nightly --release

      - name: Test with gul_nightly
        run: |
          ./target/release/gulc compilers/shared/tests/sanity_check.mn -o sanity_nightly
          ./sanity_nightly

      - name: Test with gul_stable
        working-directory: compilers/stable
        run: |
          ../../target/release/gul-compile tests/sanity_check.mn -o sanity_stable
          ./sanity_stable
          ../../target/release/gul-compile tests/arithmetic.mn -o arith_stable
          ./arith_stable

  # Lint and format check
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check format
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings
        continue-on-error: true

  # Nightly-specific tests
  nightly-integration:
    name: Nightly Integration Tests
    runs-on: ubuntu-latest
    needs: compilers
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build nightly
        run: cargo build -p gul_nightly --release

      - name: Run test suite
        run: |
          cd compilers/nightly
          python3 tests/run_tests.py || true
